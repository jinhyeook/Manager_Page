{% extends "base.html" %}

{% block title %}디바이스 관리 - 공유킥보드 관리자{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-scooter"></i> 디바이스 관리
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-map"></i> 디바이스 위치 지도</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshMap()">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="map" style="height: 500px; width: 100%;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 디바이스 정보</h5>
            </div>
            <div class="card-body">
                <div id="device-info">
                    <p class="text-muted">지도에서 디바이스를 선택하세요.</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-battery-quarter"></i> 배터리 부족 디바이스</h5>
            </div>
            <div class="card-body">
                <div id="low-battery-list">
                    <p class="text-muted">배터리 부족 디바이스를 불러오는 중...</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-qrcode"></i> QR 코드</h5>
            </div>
            <div class="card-body">
                <div id="qrcode">
                    <p class="text-muted">디바이스를 선택하면 QR 코드가 표시됩니다.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 디바이스 상세 정보 모달 -->
<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">디바이스 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deviceModalBody">
                <!-- 디바이스 정보가 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .device-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        cursor: pointer;
    }
    .battery-low {
        background-color: #dc3545;
    }
    .battery-medium {
        background-color: #ffc107;
    }
    .battery-high {
        background-color: #28a745;
    }
    .device-in-use {
        background-color: #6f42c1;
    }
    .device-info-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .device-info-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
let map;
let markers = [];
let selectedDevice = null;
let selectedDeviceId = null; // 현재 선택된 디바이스 ID 추적

$(document).ready(function() {
    initMap();
    loadLowBatteryDevices();
    
    // 1초마다 데이터 새로고침 (실시간 배터리 업데이트)
    setInterval(function() {
        refreshMap();
        loadLowBatteryDevices();
        // 선택된 디바이스가 있으면 해당 디바이스 정보 업데이트
        if (selectedDeviceId) {
            updateSelectedDeviceInfo();
        }
    }, 1000);
});

function initMap() {
    map = L.map('map').setView([37.5665, 126.9780], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    loadDevices();
}

function loadDevices() {
    console.log('loadDevices 호출됨 - 디바이스 목록 로딩 시작');
    $.get('/api/web/devices', function(devices) {
        console.log('API에서 받은 디바이스 목록:', devices);
        
        // 기존 마커 제거
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        console.log('기존 마커 제거 완료');
        
        // 위치별로 기기들을 그룹화 (소수점 4자리 기준)
        const deviceGroups = {};
        devices.forEach(device => {
            const key = `${device.latitude.toFixed(4)}_${device.longitude.toFixed(4)}`;
            if (!deviceGroups[key]) {
                deviceGroups[key] = [];
            }
            deviceGroups[key].push(device);
        });
        
        // 그룹별로 마커 생성
        Object.keys(deviceGroups).forEach(key => {
            const groupDevices = deviceGroups[key];
            const firstDevice = groupDevices[0];
            
            // status가 'in_use'이면 보라색, 아니면 배터리 레벨에 따른 색상
            let markerClass;
            if (firstDevice.status === 'in_use') {
                markerClass = 'device-in-use';
            } else {
                markerClass = firstDevice.battery_level > 50 ? 'battery-high' : 
                             firstDevice.battery_level > 20 ? 'battery-medium' : 'battery-low';
            }
            
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="device-marker ${markerClass}" style="
                        width: ${groupDevices.length > 1 ? '25px' : '20px'}; 
                        height: ${groupDevices.length > 1 ? '25px' : '20px'};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: ${groupDevices.length > 1 ? '12px' : '10px'};
                    ">
                        ${groupDevices.length > 1 ? groupDevices.length : ''}
                    </div>
                `,
                iconSize: [groupDevices.length > 1 ? 25 : 20, groupDevices.length > 1 ? 25 : 20],
                iconAnchor: [groupDevices.length > 1 ? 12.5 : 10, groupDevices.length > 1 ? 12.5 : 10]
            });
            
            const marker = L.marker([firstDevice.latitude, firstDevice.longitude], {icon: icon})
                .addTo(map);
            
            marker.on('click', function() {
                if (groupDevices.length === 1) {
                    // 단일 기기
                    showDeviceInfo(groupDevices[0]);
                } else {
                    // 겹쳐있는 기기들 - 선택할 수 있는 목록 표시
                    showDeviceSelectionModal(groupDevices);
                }
            });
            
            markers.push(marker);
        });
        
        console.log(`${markers.length}개의 마커 생성 완료`);
    });
}

function showDeviceSelectionModal(devices) {
    // 겹쳐있는 기기들을 선택할 수 있는 모달 표시
    let modalContent = `
        <div class="modal fade" id="deviceSelectionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">기기 선택</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>같은 위치에 있는 기기들입니다. 선택하세요:</p>
                        <div class="list-group">
    `;
    
    devices.forEach(device => {
        const batteryStatus = device.battery_level > 50 ? '양호' : 
                             device.battery_level > 20 ? '주의' : 
                             device.battery_level > 0 ? '충전 필요' : '기기 멈춤';
        const batteryClass = device.battery_level > 50 ? 'text-success' : 
                            device.battery_level > 20 ? 'text-warning' : 
                            device.battery_level > 0 ? 'text-danger' : 'text-dark';
        
        modalContent += `
            <button type="button" class="list-group-item list-group-item-action" onclick="selectDeviceFromModal('${device.device_id}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${device.device_id}</h6>
                    <small class="${device.status === 'in_use' ? 'text-danger' : 'text-success'}">${device.status === 'in_use' ? '사용 중' : '사용 가능'}</small>
                </div>
                <p class="mb-1">
                    <span class="${batteryClass}">배터리: ${device.battery_level}% (${batteryStatus})</span>
                </p>
                ${device.status === 'in_use' && device.current_user_id ? `<small>사용자: ${device.current_user_id}</small>` : ''}
            </button>
        `;
    });
    
    modalContent += `
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 기존 모달 제거
    $('#deviceSelectionModal').remove();
    
    // 새 모달 추가
    $('body').append(modalContent);
    
    // 모달 표시
    $('#deviceSelectionModal').modal('show');
}

function selectDeviceFromModal(deviceId) {
    // 모달 닫기
    $('#deviceSelectionModal').modal('hide');
    
    // 선택된 기기 정보 가져오기
    $.get(`/api/web/devices/${deviceId}`, function(device) {
        showDeviceInfo(device);
    }).fail(function() {
        console.log('선택된 디바이스 정보 가져오기 실패');
    });
}

function showDeviceInfo(device) {
    selectedDevice = device;
    selectedDeviceId = device.device_id; // 선택된 디바이스 ID 저장
    
    updateDeviceInfoDisplay(device);
    updateQRCode(device.device_id);
}

function updateDeviceInfoDisplay(device) {
    const batteryStatus = device.battery_level > 50 ? '양호' : 
                         device.battery_level > 20 ? '주의' : 
                         device.battery_level > 0 ? '충전 필요' : '기기 멈춤';
    const batteryClass = device.battery_level > 50 ? 'text-success' : 
                        device.battery_level > 20 ? 'text-warning' : 
                        device.battery_level > 0 ? 'text-danger' : 'text-dark';
    
    const statusText = {
        'available': '사용 가능',
        'in_use': '사용 중'
    };
    
    const html = `
        <div class="device-info-item">
            <strong>디바이스 ID:</strong> ${device.device_id}
        </div>
        <div class="device-info-item">
            <strong>위치:</strong> ${device.latitude.toFixed(6)}, ${device.longitude.toFixed(6)}
        </div>
        <div class="device-info-item">
            <strong>배터리:</strong> <span class="${batteryClass}">${device.battery_level}% (${batteryStatus})</span>
        </div>
        <div class="device-info-item">
            <strong>상태:</strong> <span class="${device.status === 'in_use' ? 'text-danger' : 'text-success'}">${device.status === 'in_use' ? '사용 중' : '사용 가능'}</span>
        </div>
        ${device.status === 'in_use' && device.current_user_id ? `
        <div class="device-info-item">
            <strong>사용자:</strong> <span class="text-primary">${device.current_user_id}</span>
        </div>
        ` : ''}
        <div class="mt-3">
            <button class="btn btn-primary btn-sm" onclick="showDeviceModal('${device.device_id}')">
                <i class="fas fa-edit"></i> 상세 정보
            </button>
        </div>
    `;
    
    $('#device-info').html(html);
}

function updateSelectedDeviceInfo() {
    if (!selectedDeviceId) return;
    
    $.get(`/api/web/devices/${selectedDeviceId}`, function(device) {
        selectedDevice = device;
        updateDeviceInfoDisplay(device);
        updateQRCode(device.device_id);
    }).fail(function() {
        console.log('선택된 디바이스 정보 업데이트 실패');
    });
}

function updateQRCode(deviceId) {
    // QR 코드 생성
    $('#qrcode').empty();
    new QRCode(document.getElementById("qrcode"), {
        text: deviceId,
        width: 128,
        height: 128,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });
}

function showDeviceModal(deviceId) {
    console.log('showDeviceModal 호출됨, deviceId:', deviceId);
    $.get(`/api/web/devices/${deviceId}`, function(device) {
        console.log('API 응답 받음:', device);
        // selectedDevice 변수 설정
        selectedDevice = device;
        console.log('selectedDevice 설정됨:', selectedDevice);
        
        const batteryStatus = device.battery_level > 50 ? '양호' : 
                             device.battery_level > 20 ? '주의' : 
                             device.battery_level > 0 ? '충전 필요' : '기기 멈춤';
        const batteryClass = device.battery_level > 50 ? 'text-success' : 
                            device.battery_level > 20 ? 'text-warning' : 
                            device.battery_level > 0 ? 'text-danger' : 'text-dark';
        
        const statusText = {
            'available': '사용 가능',
            'in_use': '사용 중'
        };
        
        const statusDisplay = statusText[device.status] || device.status;
        
        const html = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label"><strong>디바이스 ID</strong></label>
                        <input type="text" class="form-control" value="${device.device_id}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>위도</strong></label>
                        <input type="text" class="form-control" value="${device.latitude}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>경도</strong></label>
                        <input type="text" class="form-control" value="${device.longitude}" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label"><strong>배터리 레벨</strong></label>
                        <div class="progress">
                            <div class="progress-bar ${batteryClass}" style="width: ${device.battery_level}%">
                                ${device.battery_level}%
                            </div>
                        </div>
                        <small class="${batteryClass}">${batteryStatus}</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>상태</strong></label>
                        <input type="text" class="form-control" value="${device.status === 'in_use' ? '사용 중' : '사용 가능'}" readonly>
                    </div>
                    ${device.status === 'in_use' && device.current_user_id ? `
                    <div class="mb-3">
                        <label class="form-label"><strong>사용자</strong></label>
                        <input type="text" class="form-control" value="${device.current_user_id}" readonly>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        $('#deviceModalBody').html(html);
        $('#deviceModal').modal('show');
    });
}



function loadLowBatteryDevices() {
    $.get('/api/web/devices', function(devices) {
        const lowBatteryDevices = devices.filter(device => device.battery_level < 20);
        
        let html = '';
        if (lowBatteryDevices.length === 0) {
            html = '<p class="text-success">배터리 부족 디바이스가 없습니다.</p>';
        } else {
            lowBatteryDevices.forEach(device => {
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>${device.device_id}</strong>
                            <span class="text-danger">${device.battery_level}%</span>
                        </div>
                        <div class="text-muted small">${device.latitude.toFixed(4)}, ${device.longitude.toFixed(4)}</div>
                    </div>
                `;
            });
        }
        
        $('#low-battery-list').html(html);
    });
}

function refreshMap() {
    console.log('refreshMap 호출됨 - 지도 새로고침 시작');
    loadDevices();
    loadLowBatteryDevices();
    
    // 선택된 디바이스가 있으면 해당 디바이스 정보도 업데이트
    if (selectedDeviceId) {
        updateSelectedDeviceInfo();
    }
    
    console.log('refreshMap 완료 - 지도 새로고침 완료');
}
</script>
{% endblock %}
