{% extends "base.html" %}

{% block title %}디바이스 관리 - 공유킥보드 관리자{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-scooter"></i> 디바이스 관리
        </h1>
    </div>
</div>

<!-- 뷰 전환 버튼 -->
<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary active" id="mapViewBtn" onclick="switchView('map')">
                <i class="fas fa-map"></i> 지도 뷰
            </button>
            <button type="button" class="btn btn-outline-primary" id="listViewBtn" onclick="switchView('list')">
                <i class="fas fa-list"></i> 리스트 뷰
            </button>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> 
                <strong>지도 뷰</strong>는 자동 새로고침(1초), 
                <strong>리스트 뷰</strong>는 수동 새로고침입니다.
            </small>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- 지도 뷰 -->
        <div class="card" id="mapView">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-map"></i> 디바이스 위치 지도</h5>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="refreshMap()">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="map" style="height: 500px; width: 100%;"></div>
            </div>
        </div>
        
        <!-- 리스트 뷰 -->
        <div class="card" id="listView" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> 디바이스 목록</h5>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="refreshDeviceList()">
                        <i class="fas fa-sync-alt"></i> 새로고침
                    </button>
                </div>
            </div>
           <div class="card-body">
               <!-- 페이징 정보 표시 -->
               <div class="row mb-3">
                   <div class="col-md-6">
                       <div class="d-flex align-items-center">
                           <span class="text-muted me-2">페이지당 표시:</span>
                           <select class="form-select form-select-sm" id="perPageSelect" style="width: auto;" onchange="changePerPage()">
                               <option value="10">10개</option>
                               <option value="20">20개</option>
                               <option value="50">50개</option>
                               <option value="100">100개</option>
                           </select>
                       </div>
                   </div>
                   <div class="col-md-6">
                       <div class="text-end">
                           <span id="paginationInfo" class="text-muted"></span>
                       </div>
                   </div>
               </div>
               
               <div class="table-responsive">
                   <table class="table table-hover" id="deviceTable">
                       <thead class="table-dark">
                           <tr>
                               <th>디바이스 ID</th>
                               <th>타입</th>
                               <th>상태</th>
                               <th>배터리</th>
                               <th>위치</th>
                               <th>마지막 업데이트</th>
                               <th>사용자</th>
                               <th>액션</th>
                           </tr>
                       </thead>
                       <tbody id="deviceTableBody">
                           <tr>
                               <td colspan="8" class="text-center text-muted">
                                   <i class="fas fa-spinner fa-spin"></i> 디바이스 목록을 불러오는 중...
                               </td>
                           </tr>
                       </tbody>
                   </table>
               </div>
               
               <!-- 페이징 네비게이션 -->
               <nav aria-label="디바이스 목록 페이징">
                   <ul class="pagination justify-content-center" id="paginationNav">
                       <!-- 페이징 버튼들이 여기에 동적으로 생성됩니다 -->
                   </ul>
               </nav>
           </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 디바이스 정보</h5>
            </div>
            <div class="card-body">
                <div id="device-info">
                    <p class="text-muted">지도에서 디바이스를 선택하세요.</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-battery-quarter"></i> 배터리 부족 디바이스</h5>
            </div>
            <div class="card-body">
                <div id="low-battery-list">
                    <p class="text-muted">배터리 부족 디바이스를 불러오는 중...</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-qrcode"></i> QR 코드</h5>
            </div>
            <div class="card-body">
                <div id="qrcode">
                    <p class="text-muted">디바이스를 선택하면 QR 코드가 표시됩니다.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 디바이스 상세 정보 모달 -->
<div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">디바이스 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deviceModalBody">
                <!-- 디바이스 정보가 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .device-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        cursor: pointer;
    }
    .battery-low {
        background-color: #dc3545;
    }
    .battery-medium {
        background-color: #ffc107;
    }
    .battery-high {
        background-color: #28a745;
    }
    
    /* 리스트 뷰 스타일 */
    #deviceTable {
        font-size: 0.9rem;
    }
    
    #deviceTable th {
        font-size: 0.85rem;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    #deviceTable td {
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .badge {
        font-size: 0.75rem;
    }
    
    /* 뷰 전환 버튼 스타일 */
    .btn-group .btn.active {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }
    
    .btn-group .btn {
        border-radius: 0.375rem;
        margin-right: 0;
    }
    
    .btn-group .btn:first-child {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    
    .btn-group .btn:last-child {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    .device-in-use {
        background-color: #6f42c1;
    }
    .device-info-item {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    .device-info-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
let map;
let markers = [];
let deviceMarkers = {}; // 디바이스 ID별 마커 저장
let selectedDevice = null;
let selectedDeviceId = null; // 현재 선택된 디바이스 ID 추적

// 페이징 관련 변수
let currentPage = 1;
let perPage = 10;
let totalPages = 1;
let totalDevices = 0;

$(document).ready(function() {
    initMap();
    loadLowBatteryDevices();
    
    // 초기 뷰 설정 (지도 뷰가 기본)
    switchView('map');
    
    // 지도 뷰는 자동 새로고침, 리스트 뷰는 수동 새로고침
    setInterval(function() {
        // 지도 뷰가 활성화된 경우에만 자동 새로고침
        if (document.getElementById('mapView').style.display !== 'none') {
            refreshMap();
            loadLowBatteryDevices();
        }
        
        // 선택된 디바이스가 있으면 해당 디바이스 정보 업데이트
        if (selectedDeviceId) {
            updateSelectedDeviceInfo();
        }
    }, 1000);
});

function initMap() {
    map = L.map('map').setView([37.5665, 126.9780], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    loadDevices();
}

function loadDevices() {
    console.log('loadDevices 호출됨 - 디바이스 목록 로딩 시작');
    // 지도에서는 모든 디바이스를 표시하기 위해 큰 per_page 값 사용
    $.get('/api/web/devices', { per_page: 1000 }, function(response) {
        console.log('API에서 받은 응답:', response);
        
        // 페이징 정보가 포함된 응답에서 devices 배열 추출
        const devices = response.devices || response;
        console.log('디바이스 목록:', devices);
        
        // 기존 마커 제거
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        deviceMarkers = {}; // 디바이스 마커 객체 초기화
        console.log('기존 마커 제거 완료');
        
        // 위치별로 기기들을 그룹화 (소수점 4자리 기준)
        const deviceGroups = {};
        devices.forEach(device => {
            if (device.latitude && device.longitude) {
                const key = `${device.latitude.toFixed(4)}_${device.longitude.toFixed(4)}`;
                if (!deviceGroups[key]) {
                    deviceGroups[key] = [];
                }
                deviceGroups[key].push(device);
            } else {
                console.warn('위치 정보가 없는 디바이스:', device.device_id);
            }
        });
        
        console.log('그룹화된 디바이스:', deviceGroups);
        
        // 그룹별로 마커 생성
        Object.keys(deviceGroups).forEach(key => {
            const groupDevices = deviceGroups[key];
            const firstDevice = groupDevices[0];
            
            console.log(`마커 생성 중: 위치 ${key}, 디바이스 수 ${groupDevices.length}`);
            
            // status가 'in_use'이면 보라색, 아니면 배터리 레벨에 따른 색상
            let markerClass;
            if (firstDevice.status === 'in_use') {
                markerClass = 'device-in-use';
            } else {
                markerClass = firstDevice.battery_level > 50 ? 'battery-high' : 
                             firstDevice.battery_level > 20 ? 'battery-medium' : 'battery-low';
            }
            
            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div class="device-marker ${markerClass}" style="
                        width: ${groupDevices.length > 1 ? '25px' : '20px'}; 
                        height: ${groupDevices.length > 1 ? '25px' : '20px'};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: ${groupDevices.length > 1 ? '12px' : '10px'};
                    ">
                        ${groupDevices.length > 1 ? groupDevices.length : ''}
                    </div>
                `,
                iconSize: [groupDevices.length > 1 ? 25 : 20, groupDevices.length > 1 ? 25 : 20],
                iconAnchor: [groupDevices.length > 1 ? 12.5 : 10, groupDevices.length > 1 ? 12.5 : 10]
            });
            
            const marker = L.marker([firstDevice.latitude, firstDevice.longitude], {icon: icon})
                .addTo(map);
            
            console.log(`마커 추가됨: ${firstDevice.device_id} at [${firstDevice.latitude}, ${firstDevice.longitude}]`);
            
            marker.on('click', function() {
                if (groupDevices.length === 1) {
                    // 단일 기기
                    showDeviceInfo(groupDevices[0]);
                } else {
                    // 겹쳐있는 기기들 - 선택할 수 있는 목록 표시
                    showDeviceSelectionModal(groupDevices);
                }
            });
            
            markers.push(marker);
            
            // 각 디바이스를 deviceMarkers 객체에 저장
            groupDevices.forEach(device => {
                deviceMarkers[device.device_id] = marker;
            });
        });
        
        console.log(`${markers.length}개의 마커 생성 완료`);
    });
}

function showDeviceSelectionModal(devices) {
    // 겹쳐있는 기기들을 선택할 수 있는 모달 표시
    let modalContent = `
        <div class="modal fade" id="deviceSelectionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">기기 선택</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>같은 위치에 있는 기기들입니다. 선택하세요:</p>
                        <div class="list-group">
    `;
    
    devices.forEach(device => {
        const batteryStatus = device.battery_level > 50 ? '양호' : 
                             device.battery_level > 20 ? '주의' : 
                             device.battery_level > 0 ? '충전 필요' : '기기 멈춤';
        const batteryClass = device.battery_level > 50 ? 'text-success' : 
                            device.battery_level > 20 ? 'text-warning' : 
                            device.battery_level > 0 ? 'text-danger' : 'text-dark';
        
        modalContent += `
            <button type="button" class="list-group-item list-group-item-action" onclick="selectDeviceFromModal('${device.device_id}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${device.device_id}</h6>
                    <small class="${device.status === 'in_use' ? 'text-danger' : 'text-success'}">${device.status === 'in_use' ? '사용 중' : '사용 가능'}</small>
                </div>
                <p class="mb-1">
                    <span class="${batteryClass}">배터리: ${device.battery_level}% (${batteryStatus})</span>
                </p>
                ${device.status === 'in_use' && device.current_user_id ? `<small>사용자: ${device.current_user_id}</small>` : ''}
            </button>
        `;
    });
    
    modalContent += `
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 기존 모달 제거
    $('#deviceSelectionModal').remove();
    
    // 새 모달 추가
    $('body').append(modalContent);
    
    // 모달 표시
    $('#deviceSelectionModal').modal('show');
}

function selectDeviceFromModal(deviceId) {
    // 모달 닫기
    $('#deviceSelectionModal').modal('hide');
    
    // 선택된 기기 정보 가져오기
    $.get(`/api/web/devices/${deviceId}`, function(device) {
        showDeviceInfo(device);
    }).fail(function() {
        console.log('선택된 디바이스 정보 가져오기 실패');
    });
}

function showDeviceInfo(device) {
    selectedDevice = device;
    selectedDeviceId = device.device_id; // 선택된 디바이스 ID 저장
    
    updateDeviceInfoDisplay(device);
    updateQRCode(device.device_id);
}

function updateDeviceInfoDisplay(device) {
    const batteryStatus = device.battery_level > 50 ? '양호' : 
                         device.battery_level > 20 ? '주의' : 
                         device.battery_level > 0 ? '충전 필요' : '기기 멈춤';
    const batteryClass = device.battery_level > 50 ? 'text-success' : 
                        device.battery_level > 20 ? 'text-warning' : 
                        device.battery_level > 0 ? 'text-danger' : 'text-dark';
    
    const statusText = {
        'available': '사용 가능',
        'in_use': '사용 중'
    };
    
    const html = `
        <div class="device-info-item">
            <strong>디바이스 ID:</strong> ${device.device_id}
        </div>
        <div class="device-info-item">
            <strong>위치:</strong> ${device.latitude.toFixed(6)}, ${device.longitude.toFixed(6)}
        </div>
        <div class="device-info-item">
            <strong>배터리:</strong> <span class="${batteryClass}">${device.battery_level}% (${batteryStatus})</span>
        </div>
        <div class="device-info-item">
            <strong>상태:</strong> <span class="${device.status === 'in_use' ? 'text-danger' : 'text-success'}">${device.status === 'in_use' ? '사용 중' : '사용 가능'}</span>
        </div>
        ${device.status === 'in_use' && device.current_user_id ? `
        <div class="device-info-item">
            <strong>사용자:</strong> <span class="text-primary">${device.current_user_id}</span>
        </div>
        ` : ''}
        <div class="mt-3">
            <button class="btn btn-primary btn-sm" onclick="showDeviceModal('${device.device_id}')">
                <i class="fas fa-edit"></i> 상세 정보
            </button>
        </div>
    `;
    
    $('#device-info').html(html);
}

function updateSelectedDeviceInfo() {
    if (!selectedDeviceId) return;
    
    $.get(`/api/web/devices/${selectedDeviceId}`, function(device) {
        selectedDevice = device;
        updateDeviceInfoDisplay(device);
        updateQRCode(device.device_id);
    }).fail(function() {
        console.log('선택된 디바이스 정보 업데이트 실패');
    });
}

function updateQRCode(deviceId) {
    // QR 코드 생성
    $('#qrcode').empty();
    new QRCode(document.getElementById("qrcode"), {
        text: deviceId,
        width: 128,
        height: 128,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });
}

// 뷰 전환 함수
function switchView(viewType) {
    const mapView = document.getElementById('mapView');
    const listView = document.getElementById('listView');
    const mapViewBtn = document.getElementById('mapViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    
    if (viewType === 'map') {
        mapView.style.display = 'block';
        listView.style.display = 'none';
        mapViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
    } else if (viewType === 'list') {
        mapView.style.display = 'none';
        listView.style.display = 'block';
        mapViewBtn.classList.remove('active');
        listViewBtn.classList.add('active');
        // 리스트 뷰로 전환할 때 디바이스 목록 로드
        loadDeviceList();
    }
}

// 디바이스 목록 로드 함수 (페이징 지원)
function loadDeviceList(page = currentPage) {
    const tbody = document.getElementById('deviceTableBody');
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> 디바이스 목록을 불러오는 중...</td></tr>';
    
    $.get('/api/web/devices', {
        page: page,
        per_page: perPage
    }).done(function(response) {
        const devices = response.devices;
        const pagination = response.pagination;
        
        // 페이징 정보 업데이트
        currentPage = pagination.page;
        totalPages = pagination.pages;
        totalDevices = pagination.total;
        
        // 페이징 정보 표시
        updatePaginationInfo();
        
        // 테이블 내용 업데이트
        tbody.innerHTML = '';
        
        if (devices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">등록된 디바이스가 없습니다.</td></tr>';
            updatePaginationNav();
            return;
        }
        
        devices.forEach(function(device) {
            const row = createDeviceTableRow(device);
            tbody.appendChild(row);
        });
        
        // 페이징 네비게이션 업데이트
        updatePaginationNav();
        
    }).fail(function() {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">디바이스 목록을 불러오는데 실패했습니다.</td></tr>';
    });
}

// 디바이스 테이블 행 생성 함수
function createDeviceTableRow(device) {
    const row = document.createElement('tr');
    
    // 상태에 따른 배지 클래스
    const statusClass = device.status === 'in_use' ? 'badge bg-warning' : 'badge bg-success';
    const statusText = device.status === 'in_use' ? '사용 중' : '사용 가능';
    
    // 배터리 상태에 따른 클래스
    let batteryClass = 'text-success';
    if (device.battery_level <= 20) batteryClass = 'text-danger';
    else if (device.battery_level <= 50) batteryClass = 'text-warning';
    
    // 위치 정보
    const location = device.latitude && device.longitude ? 
        `${device.latitude.toFixed(6)}, ${device.longitude.toFixed(6)}` : 
        '위치 정보 없음';
    
    // 마지막 업데이트 시간
    const lastUpdated = device.last_updated ? 
        new Date(device.last_updated).toLocaleString('ko-KR') : 
        '정보 없음';
    
    // 사용자 정보
    const currentUser = device.current_user_id || '-';
    
    row.innerHTML = `
        <td><strong>${device.device_id}</strong></td>
        <td><span class="badge bg-info">${device.device_type || '킥보드'}</span></td>
        <td><span class="${statusClass}">${statusText}</span></td>
        <td><span class="${batteryClass}">${device.battery_level}%</span></td>
        <td><small>${location}</small></td>
        <td><small>${lastUpdated}</small></td>
        <td><small>${currentUser}</small></td>
        <td>
            <button class="btn btn-sm btn-outline-primary" onclick="selectDeviceFromList('${device.device_id}')" title="상세보기">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="showDeviceModal('${device.device_id}')" title="모달로 보기">
                <i class="fas fa-info-circle"></i>
            </button>
        </td>
    `;
    
    return row;
}

// 리스트에서 디바이스 선택 함수
function selectDeviceFromList(deviceId) {
    // 지도 뷰로 전환
    switchView('map');
    
    // 해당 디바이스 정보 로드
    $.get(`/api/web/devices/${deviceId}`, function(device) {
        selectedDevice = device;
        updateDeviceInfoDisplay(device);
        updateQRCode(device.device_id);
        
        // 지도에서 해당 마커로 이동 (지도가 로드된 경우)
        if (map && deviceMarkers && deviceMarkers[deviceId]) {
            const marker = deviceMarkers[deviceId];
            map.setView(marker.getLatLng(), 16);
            marker.openPopup();
        }
    });
}

// 리스트 새로고침 함수
function refreshDeviceList() {
    loadDeviceList(currentPage);
}

// 페이징 정보 업데이트 함수
function updatePaginationInfo() {
    const startItem = (currentPage - 1) * perPage + 1;
    const endItem = Math.min(currentPage * perPage, totalDevices);
    const infoText = `총 ${totalDevices}개 중 ${startItem}-${endItem}개 표시`;
    document.getElementById('paginationInfo').textContent = infoText;
}

// 페이징 네비게이션 업데이트 함수
function updatePaginationNav() {
    const nav = document.getElementById('paginationNav');
    nav.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // 이전 페이지 버튼
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">이전</a>`;
    nav.appendChild(prevLi);
    
    // 페이지 번호 버튼들
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(1)">1</a>`;
        nav.appendChild(firstLi);
        
        if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            nav.appendChild(ellipsisLi);
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
        nav.appendChild(li);
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            nav.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${totalPages})">${totalPages}</a>`;
        nav.appendChild(lastLi);
    }
    
    // 다음 페이지 버튼
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">다음</a>`;
    nav.appendChild(nextLi);
}

// 페이지 이동 함수
function goToPage(page) {
    if (page < 1 || page > totalPages || page === currentPage) return;
    loadDeviceList(page);
}

// 페이지당 항목 수 변경 함수
function changePerPage() {
    perPage = parseInt(document.getElementById('perPageSelect').value);
    currentPage = 1; // 첫 페이지로 이동
    loadDeviceList(1);
}

function showDeviceModal(deviceId) {
    console.log('showDeviceModal 호출됨, deviceId:', deviceId);
    $.get(`/api/web/devices/${deviceId}`, function(device) {
        console.log('API 응답 받음:', device);
        // selectedDevice 변수 설정
        selectedDevice = device;
        console.log('selectedDevice 설정됨:', selectedDevice);
        
        const batteryStatus = device.battery_level > 50 ? '양호' : 
                             device.battery_level > 20 ? '주의' : 
                             device.battery_level > 0 ? '충전 필요' : '기기 멈춤';
        const batteryClass = device.battery_level > 50 ? 'text-success' : 
                            device.battery_level > 20 ? 'text-warning' : 
                            device.battery_level > 0 ? 'text-danger' : 'text-dark';
        
        const statusText = {
            'available': '사용 가능',
            'in_use': '사용 중'
        };
        
        const statusDisplay = statusText[device.status] || device.status;
        
        const html = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label"><strong>디바이스 ID</strong></label>
                        <input type="text" class="form-control" value="${device.device_id}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>위도</strong></label>
                        <input type="text" class="form-control" value="${device.latitude}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>경도</strong></label>
                        <input type="text" class="form-control" value="${device.longitude}" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label"><strong>배터리 레벨</strong></label>
                        <div class="progress">
                            <div class="progress-bar ${batteryClass}" style="width: ${device.battery_level}%">
                                ${device.battery_level}%
                            </div>
                        </div>
                        <small class="${batteryClass}">${batteryStatus}</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>상태</strong></label>
                        <input type="text" class="form-control" value="${device.status === 'in_use' ? '사용 중' : '사용 가능'}" readonly>
                    </div>
                    ${device.status === 'in_use' && device.current_user_id ? `
                    <div class="mb-3">
                        <label class="form-label"><strong>사용자</strong></label>
                        <input type="text" class="form-control" value="${device.current_user_id}" readonly>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        $('#deviceModalBody').html(html);
        $('#deviceModal').modal('show');
    });
}



function loadLowBatteryDevices() {
    // 배터리 부족 디바이스도 모든 데이터에서 확인
    $.get('/api/web/devices', { per_page: 1000 }, function(response) {
        // 페이징 정보가 포함된 응답에서 devices 배열 추출
        const devices = response.devices || response;
        const lowBatteryDevices = devices.filter(device => device.battery_level < 20);
        
        let html = '';
        if (lowBatteryDevices.length === 0) {
            html = '<p class="text-success">배터리 부족 디바이스가 없습니다.</p>';
        } else {
            lowBatteryDevices.forEach(device => {
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>${device.device_id}</strong>
                            <span class="text-danger">${device.battery_level}%</span>
                        </div>
                        <div class="text-muted small">${device.latitude.toFixed(4)}, ${device.longitude.toFixed(4)}</div>
                    </div>
                `;
            });
        }
        
        $('#low-battery-list').html(html);
    });
}

function refreshMap() {
    console.log('refreshMap 호출됨 - 지도 새로고침 시작');
    loadDevices();
    loadLowBatteryDevices();
    
    // 선택된 디바이스가 있으면 해당 디바이스 정보도 업데이트
    if (selectedDeviceId) {
        updateSelectedDeviceInfo();
    }
    
    console.log('refreshMap 완료 - 지도 새로고침 완료');
}
</script>
{% endblock %}
