{% extends "base.html" %}

{% block title %}통계 - 공유킥보드 관리자{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar"></i> 통계 대시보드
        </h1>
    </div>
</div>

<!-- 요약 카드 -->
<div class="row mb-3">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">전체 디바이스</h6>
                        <h4 id="totalDevices" class="mb-0">-</h4>
                    </div>
                    <div>
                        <i class="fas fa-scooter fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">전체 회원</h6>
                        <h4 id="totalUsers" class="mb-0">-</h4>
                    </div>
                    <div>
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">전체 신고</h6>
                        <h4 id="totalReports" class="mb-0">-</h4>
                    </div>
                    <div>
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 차트 영역 -->
<div class="row">
    <!-- 디바이스 상태 원형 차트 -->
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-chart-pie"></i> 디바이스 상태</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="deviceStatusChart" width="250" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 나이대별 분포 원형 차트 -->
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-chart-pie"></i> 나이대별 분포</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="ageChart" width="250" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 신고 유형별 통계 원형 차트 -->
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 신고 유형별</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="reportTypeChart" width="250" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 지역별 디바이스 분포 -->
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> 지역별 분포</h6>
            </div>
            <div class="card-body py-2">
                <div id="locationSummary">
                    <p class="text-muted mb-0">지역별 통계를 불러오는 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 성별 분포 막대 차트 -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-chart-bar"></i> 성별 분포</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="genderChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 배터리 레벨 분포 막대 차트 -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-battery-half"></i> 배터리 레벨 분포</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="batteryChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .bg-primary {
        background-color: #007bff !important;
    }
    
    .bg-success {
        background-color: #28a745 !important;
    }
    
    .bg-info {
        background-color: #17a2b8 !important;
    }
    
    /* 차트 컨테이너 높이 제한 */
    .card-body canvas {
        max-height: 200px !important;
    }
    
    /* 작은 카드 스타일 */
    .card-header.py-2 {
        padding: 0.5rem 1rem;
    }
    
    .card-body.py-2 {
        padding: 0.5rem 1rem;
    }
    
    /* 요약 카드 스타일 */
    .card-body.py-3 {
        padding: 0.75rem 1rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

$(document).ready(function() {
    loadStatistics();
    
    // 30초마다 데이터 새로고침
    setInterval(function() {
        loadStatistics();
    }, 30000);
});

function loadStatistics() {
    $.get('/api/statistics', function(data) {
        updateSummaryCards(data.summary);
        createDeviceStatusChart(data.device_status);
        createGenderChart(data.gender_stats);
        createAgeChart(data.age_stats);
        createBatteryChart(data.battery_stats);
        updateLocationSummary(data.location_stats);
        createReportTypeChart(data.report_type_stats);
    });
}

function updateSummaryCards(summary) {
    $('#totalDevices').text(summary.total_devices);
    $('#totalUsers').text(summary.total_users);
    $('#totalReports').text(summary.total_reports);
}

function createDeviceStatusChart(deviceStatusData) {
    const ctx = document.getElementById('deviceStatusChart').getContext('2d');
    
    // 기존 차트가 있다면 제거
    if (charts.deviceStatus) {
        charts.deviceStatus.destroy();
    }
    
    const labels = deviceStatusData.map(item => item.status);
    const data = deviceStatusData.map(item => item.count);
    const colors = ['#28a745', '#007bff']; // 사용 가능: 초록, 사용 중: 파랑
    
    charts.deviceStatus = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}개 (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createGenderChart(genderData) {
    const ctx = document.getElementById('genderChart').getContext('2d');
    
    if (charts.gender) {
        charts.gender.destroy();
    }
    
    const labels = genderData.map(item => item.gender);
    const data = genderData.map(item => item.count);
    const colors = ['#007bff', '#e83e8c']; // 남성: 파랑, 여성: 분홍
    
    charts.gender = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '회원 수',
                data: data,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createAgeChart(ageData) {
    const ctx = document.getElementById('ageChart').getContext('2d');
    
    if (charts.age) {
        charts.age.destroy();
    }
    
    const labels = ageData.map(item => item.age_group);
    const data = ageData.map(item => item.count);
    const colors = [
        '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', 
        '#feca57', '#ff9ff3', '#54a0ff'
    ];
    
    charts.age = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}명 (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createBatteryChart(batteryData) {
    const ctx = document.getElementById('batteryChart').getContext('2d');
    
    if (charts.battery) {
        charts.battery.destroy();
    }
    
    const labels = batteryData.map(item => item.battery_range);
    const data = batteryData.map(item => item.count);
    
    // 배터리 레벨에 따른 색상 설정
    const colors = labels.map(range => {
        if (range === '0-9%' || range === '10-19%') return '#dc3545'; // 빨강
        if (range === '20-29%' || range === '30-39%') return '#fd7e14'; // 주황
        if (range === '40-49%' || range === '50-59%') return '#ffc107'; // 노랑
        if (range === '60-69%' || range === '70-79%') return '#20c997'; // 청록
        return '#28a745'; // 초록
    });
    
    charts.battery = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '디바이스 수',
                data: data,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}



function updateLocationSummary(locationData) {
    let html = '';
    
    if (locationData.length === 0) {
        html = '<p class="text-muted">지역별 데이터가 없습니다.</p>';
    } else {
        // 상위 5개 지역만 표시
        const topLocations = locationData.slice(0, 5);
        
        topLocations.forEach((location, index) => {
            const rankClass = index === 0 ? 'text-warning fw-bold' : 
                            index === 1 ? 'text-secondary' : 
                            index === 2 ? 'text-danger' : 'text-muted';
            
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="${rankClass}">
                        ${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '#' + (index + 1)}
                        ${location.district}
                    </span>
                    <span class="badge bg-primary">${location.count}대</span>
                </div>
            `;
        });
        
        if (locationData.length > 5) {
            const others = locationData.slice(5).reduce((sum, loc) => sum + loc.count, 0);
            html += `
                <div class="border-top pt-2 mt-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">기타 지역</span>
                        <span class="badge bg-secondary">${others}대</span>
                    </div>
                </div>
            `;
        }
    }
    
    $('#locationSummary').html(html);
}

function createReportTypeChart(reportTypeData) {
    const ctx = document.getElementById('reportTypeChart').getContext('2d');
    
    if (charts.reportType) {
        charts.reportType.destroy();
    }
    
    const labels = reportTypeData.map(item => item.report_type);
    const data = reportTypeData.map(item => item.count);
    const colors = ['#dc3545', '#ffc107', '#17a2b8']; // 빨강, 노랑, 파랑
    
    charts.reportType = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}건 (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}

