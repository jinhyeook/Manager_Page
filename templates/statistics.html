{% extends "base.html" %}

{% block title %}í†µê³„ - ê³µìœ í‚¥ë³´ë“œ ê´€ë¦¬ì{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar"></i> í†µê³„ ëŒ€ì‹œë³´ë“œ
        </h1>
    </div>
</div>

<!-- ìš”ì•½ ì¹´ë“œ -->
<div class="row mb-3">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">ì „ì²´ ë””ë°”ì´ìŠ¤</h6>
                        <h4 id="totalDevices" class="mb-0">-</h4>
                    </div>
                    <div>
                        <i class="fas fa-scooter fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">ì „ì²´ íšŒì›</h6>
                        <h4 id="totalUsers" class="mb-0">-</h4>
                    </div>
                    <div>
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-1">ì „ì²´ ì‹ ê³ </h6>
                        <h4 id="totalReports" class="mb-0">-</h4>
                    </div>
                    <div>
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì°¨íŠ¸ ì˜ì—­ -->
<div class="row">
    <!-- ë””ë°”ì´ìŠ¤ ìƒíƒœ ì›í˜• ì°¨íŠ¸ -->
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-chart-pie"></i> ë””ë°”ì´ìŠ¤ ìƒíƒœ</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="deviceStatusChart" width="250" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- ë‚˜ì´ëŒ€ë³„ ë¶„í¬ ì›í˜• ì°¨íŠ¸ -->
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-chart-pie"></i> ë‚˜ì´ëŒ€ë³„ ë¶„í¬</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="ageChart" width="250" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- ì‹ ê³  ìœ í˜•ë³„ í†µê³„ ì›í˜• ì°¨íŠ¸ -->
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> ì‹ ê³  ìœ í˜•ë³„</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="reportTypeChart" width="250" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- ì§€ì—­ë³„ ë””ë°”ì´ìŠ¤ ë¶„í¬ -->
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-map-marker-alt"></i> ì§€ì—­ë³„ ë¶„í¬</h6>
            </div>
            <div class="card-body py-2">
                <div id="locationSummary">
                    <p class="text-muted mb-0">ì§€ì—­ë³„ í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ì„±ë³„ ë¶„í¬ ë§‰ëŒ€ ì°¨íŠ¸ -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-chart-bar"></i> ì„±ë³„ ë¶„í¬</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="genderChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- ë°°í„°ë¦¬ ë ˆë²¨ ë¶„í¬ ë§‰ëŒ€ ì°¨íŠ¸ -->
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-battery-half"></i> ë°°í„°ë¦¬ ë ˆë²¨ ë¶„í¬</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="batteryChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .bg-primary {
        background-color: #007bff !important;
    }
    
    .bg-success {
        background-color: #28a745 !important;
    }
    
    .bg-info {
        background-color: #17a2b8 !important;
    }
    
    /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ë†’ì´ ì œí•œ */
    .card-body canvas {
        max-height: 200px !important;
    }
    
    /* ì‘ì€ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card-header.py-2 {
        padding: 0.5rem 1rem;
    }
    
    .card-body.py-2 {
        padding: 0.5rem 1rem;
    }
    
    /* ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card-body.py-3 {
        padding: 0.75rem 1rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

$(document).ready(function() {
    loadStatistics();
    
    // 30ì´ˆë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    setInterval(function() {
        loadStatistics();
    }, 30000);
});

function loadStatistics() {
    $.get('/api/statistics', function(data) {
        updateSummaryCards(data.summary);
        createDeviceStatusChart(data.device_status);
        createGenderChart(data.gender_stats);
        createAgeChart(data.age_stats);
        createBatteryChart(data.battery_stats);
        updateLocationSummary(data.location_stats);
        createReportTypeChart(data.report_type_stats);
    });
}

function updateSummaryCards(summary) {
    $('#totalDevices').text(summary.total_devices);
    $('#totalUsers').text(summary.total_users);
    $('#totalReports').text(summary.total_reports);
}

function createDeviceStatusChart(deviceStatusData) {
    const ctx = document.getElementById('deviceStatusChart').getContext('2d');
    
    // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ ì œê±°
    if (charts.deviceStatus) {
        charts.deviceStatus.destroy();
    }
    
    const labels = deviceStatusData.map(item => item.status);
    const data = deviceStatusData.map(item => item.count);
    const colors = ['#28a745', '#007bff']; // ì‚¬ìš© ê°€ëŠ¥: ì´ˆë¡, ì‚¬ìš© ì¤‘: íŒŒë‘
    
    charts.deviceStatus = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}ê°œ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createGenderChart(genderData) {
    const ctx = document.getElementById('genderChart').getContext('2d');
    
    if (charts.gender) {
        charts.gender.destroy();
    }
    
    const labels = genderData.map(item => item.gender);
    const data = genderData.map(item => item.count);
    const colors = ['#007bff', '#e83e8c']; // ë‚¨ì„±: íŒŒë‘, ì—¬ì„±: ë¶„í™
    
    charts.gender = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'íšŒì› ìˆ˜',
                data: data,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createAgeChart(ageData) {
    const ctx = document.getElementById('ageChart').getContext('2d');
    
    if (charts.age) {
        charts.age.destroy();
    }
    
    const labels = ageData.map(item => item.age_group);
    const data = ageData.map(item => item.count);
    const colors = [
        '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', 
        '#feca57', '#ff9ff3', '#54a0ff'
    ];
    
    charts.age = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}ëª… (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function createBatteryChart(batteryData) {
    const ctx = document.getElementById('batteryChart').getContext('2d');
    
    if (charts.battery) {
        charts.battery.destroy();
    }
    
    const labels = batteryData.map(item => item.battery_range);
    const data = batteryData.map(item => item.count);
    
    // ë°°í„°ë¦¬ ë ˆë²¨ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
    const colors = labels.map(range => {
        if (range === '0-9%' || range === '10-19%') return '#dc3545'; // ë¹¨ê°•
        if (range === '20-29%' || range === '30-39%') return '#fd7e14'; // ì£¼í™©
        if (range === '40-49%' || range === '50-59%') return '#ffc107'; // ë…¸ë‘
        if (range === '60-69%' || range === '70-79%') return '#20c997'; // ì²­ë¡
        return '#28a745'; // ì´ˆë¡
    });
    
    charts.battery = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'ë””ë°”ì´ìŠ¤ ìˆ˜',
                data: data,
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}



function updateLocationSummary(locationData) {
    let html = '';
    
    if (locationData.length === 0) {
        html = '<p class="text-muted">ì§€ì—­ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    } else {
        // ìƒìœ„ 5ê°œ ì§€ì—­ë§Œ í‘œì‹œ
        const topLocations = locationData.slice(0, 5);
        
        topLocations.forEach((location, index) => {
            const rankClass = index === 0 ? 'text-warning fw-bold' : 
                            index === 1 ? 'text-secondary' : 
                            index === 2 ? 'text-danger' : 'text-muted';
            
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="${rankClass}">
                        ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '#' + (index + 1)}
                        ${location.district}
                    </span>
                    <span class="badge bg-primary">${location.count}ëŒ€</span>
                </div>
            `;
        });
        
        if (locationData.length > 5) {
            const others = locationData.slice(5).reduce((sum, loc) => sum + loc.count, 0);
            html += `
                <div class="border-top pt-2 mt-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">ê¸°íƒ€ ì§€ì—­</span>
                        <span class="badge bg-secondary">${others}ëŒ€</span>
                    </div>
                </div>
            `;
        }
    }
    
    $('#locationSummary').html(html);
}

function createReportTypeChart(reportTypeData) {
    const ctx = document.getElementById('reportTypeChart').getContext('2d');
    
    if (charts.reportType) {
        charts.reportType.destroy();
    }
    
    const labels = reportTypeData.map(item => item.report_type);
    const data = reportTypeData.map(item => item.count);
    const colors = ['#dc3545', '#ffc107', '#17a2b8']; // ë¹¨ê°•, ë…¸ë‘, íŒŒë‘
    
    charts.reportType = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed}ê±´ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}

