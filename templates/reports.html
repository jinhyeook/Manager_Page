{% extends "base.html" %}

{% block title %}신고 내역 관리 - 공유킥보드 관리자{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-exclamation-triangle"></i> 신고 내역 관리
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> 신고 내역 목록</h5>
                <div>
                    <select class="form-select form-select-sm" id="statusFilter" style="width: auto;">
                        <option value="">전체 상태</option>
                        <option value="resolved">해결됨</option>
                        <option value="dismissed">해결 대기 중</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>신고 ID</th>
                                <th>디바이스 ID</th>
                                <th>신고 유형</th>
                                <th>신고일</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">신고 내역을 불러오는 중...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-image"></i> 신고 사진</h5>
            </div>
            <div class="card-body">
                <div id="reportImage">
                    <p class="text-muted">신고를 선택하면 사진이 표시됩니다.</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-map-marker-alt"></i> 신고 위치</h5>
            </div>
            <div class="card-body">
                <div id="reportLocation">
                    <p class="text-muted">신고를 선택하면 위치가 표시됩니다.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 신고 상세 정보 모달 -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">신고 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportModalBody">
                <!-- 신고 정보가 여기에 표시됩니다 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-success" onclick="updateReportStatus('resolved')">해결됨</button>
                <button type="button" class="btn btn-warning" onclick="updateReportStatus('dismissed')">해결 대기 중</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .report-image {
        max-width: 100%;
        max-height: 300px;
        width: auto;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transform: rotate(90deg) !important; /* 강제 90도 회전 */
        object-fit: contain;
        display: block;
        margin: 0 auto;
    }
    
    .report-image-container {
        width: 100%;
        height: 300px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    .status-badge {
        font-size: 0.8em;
        padding: 4px 8px;
    }
    .report-location-map {
        height: 200px;
        width: 100%;
        border-radius: 8px;
        min-height: 200px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        position: relative;
    }
    
    .report-location-map:empty::before {
        content: "지도를 불러오는 중...";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #6c757d;
        font-size: 14px;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,0.05);
        cursor: pointer;
    }
</style>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
let reports = [];
let selectedReport = null;
let locationMap = null;

// 전역 변수로 상태 및 신고 유형 매핑 정의
const statusClass = {
    'pending': 'bg-warning',
    'resolved': 'bg-success',
    'dismissed': 'bg-secondary'
};

const statusText = {
    'pending': '해결 대기 중',
    'resolved': '해결됨',
    'dismissed': '해결 대기 중'
};

const reportTypeText = {
    'helmet_multi': '헬멧 미착용 및 다인 탑승',
    'helmet_single': '헬멧 미착용 및 1인 탑승',
    'no_helmet_multi': '헬멧 착용 및 다인 탑승'
};


$(document).ready(function() {
    loadReports();
    
    // 상태 필터 변경 이벤트
    $('#statusFilter').change(function() {
        filterReports();
    });
    
    // 30초마다 데이터 새로고침
    setInterval(function() {
        loadReports();
    }, 30000);
});

// 이미지 회전 수정 함수 (강제 회전)
function fixImageOrientation(img) {
    // 이미지가 완전히 로드될 때까지 대기
    if (img.naturalWidth === 0 || img.naturalHeight === 0) {
        setTimeout(() => fixImageOrientation(img), 100);
        return;
    }
    
    console.log('이미지 원본 크기:', img.naturalWidth, img.naturalHeight);
    
    // 모든 이미지에 90도 회전 적용 (임시 해결책)
    img.style.transform = 'rotate(90deg)';
    img.style.maxWidth = '100%';
    img.style.maxHeight = '400px';
    img.style.objectFit = 'contain';
    
    console.log('이미지 90도 회전 적용 완료');
}

function loadReports() {
    $.get('/api/reports', function(data) {
        reports = data;
        displayReports(data);
    });
}

function displayReports(reportsData) {
    let html = '';
    
    if (reportsData.length === 0) {
        html = '<tr><td colspan="6" class="text-center text-muted">신고 내역이 없습니다.</td></tr>';
    } else {
        reportsData.forEach(report => {
            
            
            const date = new Date(report.report_date).toLocaleDateString('ko-KR');
            
            html += `
                <tr onclick="showReportDetail(${report.id})">
                    <td>#${report.id}</td>
                    <td>${report.device_id}</td>
                    <td>${reportTypeText[report.report_type] || report.report_type}</td>
                    <td>${date}</td>
                    <td><span class="badge ${statusClass[report.status]} status-badge">${statusText[report.status]}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showReportModal(${report.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    $('#reportsTableBody').html(html);
}

function filterReports() {
    const statusFilter = $('#statusFilter').val();
    let filteredReports = reports;
    
    if (statusFilter) {
        filteredReports = reports.filter(report => report.status === statusFilter);
    }
    
    displayReports(filteredReports);
}

function showReportDetail(reportId) {
    const report = reports.find(r => r.id === reportId);
    if (!report) return;
    
    selectedReport = report;
    
    // 신고 사진 표시
    if (report.image_data) {
        $('#reportImage').html(`
            <div class="report-image-container">
                <img src="data:image/jpeg;base64,${report.image_data}" alt="신고 사진" class="report-image" onload="fixImageOrientation(this)">
            </div>
        `);
    } else {
        $('#reportImage').html(`
            <div class="text-center text-muted">
                <i class="fas fa-image fa-3x mb-2"></i>
                <p>사진이 없습니다.</p>
            </div>
        `);
    }
    
    // 신고 위치 지도 표시
    if (report.latitude && report.longitude) {
        console.log('지도 표시 시작:', report.latitude, report.longitude);
        
        // 기존 지도 완전히 제거
        if (locationMap) {
            locationMap.remove();
            locationMap = null;
        }
        
        // 지도 컨테이너 HTML 생성
        $('#reportLocation').html(`
            <div id="locationMap" class="report-location-map"></div>
            <div class="mt-2 text-center">
                <small class="text-muted">위도: ${report.latitude.toFixed(6)}, 경도: ${report.longitude.toFixed(6)}</small>
            </div>
        `);
        
        // 새 지도 생성 (DOM이 완전히 렌더링된 후)
        setTimeout(() => {
            try {
                // 지도 컨테이너가 존재하는지 확인
                const mapContainer = document.getElementById('locationMap');
                if (!mapContainer) {
                    console.error('지도 컨테이너를 찾을 수 없습니다.');
                    return;
                }
                
                // Leaflet이 로드되었는지 확인
                if (typeof L === 'undefined') {
                    console.error('Leaflet 라이브러리가 로드되지 않았습니다.');
                    $('#reportLocation').html(`
                        <div class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle fa-3x mb-2"></i>
                            <p>지도 라이브러리를 불러올 수 없습니다.</p>
                        </div>
                    `);
                    return;
                }
                
                console.log('Leaflet 라이브러리 로드 완료');
                console.log('지도 컨테이너 크기:', mapContainer.offsetWidth, mapContainer.offsetHeight);
                
                // 기존 지도 완전히 제거
                if (locationMap) {
                    locationMap.remove();
                    locationMap = null;
                }
                
                // Leaflet 지도 초기화
                locationMap = L.map('locationMap', {
                    center: [report.latitude, report.longitude],
                    zoom: 15,
                    zoomControl: true,
                    preferCanvas: false
                });
                
                // 여러 타일 서버 시도
                const tileLayers = [
                    {
                        name: 'OpenStreetMap',
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        attribution: '© OpenStreetMap contributors',
                        subdomains: ['a', 'b', 'c']
                    },
                    {
                        name: 'CartoDB',
                        url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
                        attribution: '© OpenStreetMap contributors © CARTO',
                        subdomains: ['a', 'b', 'c', 'd']
                    },
                    {
                        name: 'Stamen',
                        url: 'https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}{r}.png',
                        attribution: 'Map tiles by Stamen Design, CC BY 3.0 — Map data © OpenStreetMap contributors',
                        subdomains: ['a', 'b', 'c', 'd']
                    }
                ];
                
                // 첫 번째 타일 레이어 추가
                const tileLayer = L.tileLayer(tileLayers[0].url, {
                    attribution: tileLayers[0].attribution,
                    maxZoom: 18,
                    minZoom: 1,
                    subdomains: tileLayers[0].subdomains
                });
                
                tileLayer.addTo(locationMap);
                
                // 타일 로드 실패 시 다른 서버로 전환
                tileLayer.on('tileerror', function(e) {
                    console.error('타일 로드 실패, 다른 서버로 전환:', e);
                    
                    // 현재 타일 레이어 제거
                    locationMap.removeLayer(tileLayer);
                    
                    // 다음 타일 서버 시도
                    const currentIndex = tileLayers.findIndex(layer => layer.url === tileLayer._url);
                    const nextIndex = (currentIndex + 1) % tileLayers.length;
                    const nextLayer = tileLayers[nextIndex];
                    
                    const newTileLayer = L.tileLayer(nextLayer.url, {
                        attribution: nextLayer.attribution,
                        maxZoom: 18,
                        minZoom: 1,
                        subdomains: nextLayer.subdomains
                    });
                    
                    newTileLayer.addTo(locationMap);
                    console.log(`타일 서버 변경: ${nextLayer.name}`);
                });
                
                // 마커 추가
                const marker = L.marker([report.latitude, report.longitude])
                    .bindPopup(`
                        <div>
                            <strong>신고 위치</strong><br>
                            위도: ${report.latitude.toFixed(6)}<br>
                            경도: ${report.longitude.toFixed(6)}
                        </div>
                    `)
                    .addTo(locationMap);
                
                // 마커 자동으로 팝업 열기
                marker.openPopup();
                
                // 지도 크기 조정
                setTimeout(() => {
                    if (locationMap) {
                        locationMap.invalidateSize();
                        console.log('지도 크기 조정 완료');
                    }
                }, 100);
                
                console.log('Leaflet 지도 생성 완료');
            } catch (error) {
                console.error('지도 생성 오류:', error);
                $('#reportLocation').html(`
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle fa-3x mb-2"></i>
                        <p>지도를 불러올 수 없습니다.</p>
                        <small>오류: ${error.message}</small>
                    </div>
                `);
            }
        }, 500);
    } else {
        console.log('위치 정보 없음:', report.latitude, report.longitude);
        $('#reportLocation').html(`
            <div class="text-center text-muted">
                <i class="fas fa-map-marker-alt fa-3x mb-2"></i>
                <p>위치 정보가 없습니다.</p>
            </div>
        `);
    }
}

function showReportModal(reportId) {
    const report = reports.find(r => r.id === reportId);
    if (!report) return;
    
    const date = new Date(report.report_date).toLocaleString('ko-KR');
    
    const html = `
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>신고 ID</strong></label>
                    <input type="text" class="form-control" value="#${report.id}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>디바이스 ID</strong></label>
                    <input type="text" class="form-control" value="${report.device_id}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>신고 유형</strong></label>
                    <input type="text" class="form-control" value="${reportTypeText[report.report_type] || report.report_type}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>신고일</strong></label>
                    <input type="text" class="form-control" value="${date}" readonly>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>현재 상태</strong></label>
                    <input type="text" class="form-control" value="${statusText[report.status]}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>위치</strong></label>
                    <input type="text" class="form-control" value="${report.latitude ? report.latitude.toFixed(6) : 'N/A'}, ${report.longitude ? report.longitude.toFixed(6) : 'N/A'}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>신고자 ID</strong></label>
                    <input type="text" class="form-control" value="${report.user_id || 'N/A'}" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>설명</strong></label>
                    <textarea class="form-control" rows="3" readonly>${report.description || '설명 없음'}</textarea>
                </div>
            </div>
        </div>
        ${report.image_data ? `
        <div class="row mt-3">
            <div class="col-12">
                <label class="form-label"><strong>신고 사진</strong></label>
                <div class="report-image-container">
                    <img src="data:image/jpeg;base64,${report.image_data}" alt="신고 사진" class="report-image" onload="fixImageOrientation(this)">
                </div>
            </div>
        </div>
        ` : ''}
    `;
    
    $('#reportModalBody').html(html);
    $('#reportModal').modal('show');
}

function updateReportStatus(newStatus) {
    if (!selectedReport) return;
    
    // API 호출로 상태 업데이트
    $.ajax({
        url: `/api/reports/${selectedReport.device_id}/status`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({
            status: newStatus
        }),
        success: function(response) {
            $('#reportModal').modal('hide');
            alert('상태가 업데이트되었습니다.');
            loadReports(); // 신고 목록 새로고침
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : '상태 업데이트 중 오류가 발생했습니다.';
            alert('오류: ' + error);
        }
    });
}
</script>
{% endblock %}
